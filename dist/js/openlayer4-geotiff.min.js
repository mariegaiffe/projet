function GeoCanvas(e,t,a){this.map=e,this.url=t,this.options=a;var i=this;this.init=function(){this.options.opacity||(this.options.opacity=1),i.make()},this.make=function(){var e=new XMLHttpRequest;e.onreadystatechange=function(){4==e.readyState&&200==e.status&&i.parseTiff(e.response)},e.open("GET",this.url,!0),e.responseType="arraybuffer",e.send(null)},this.parseTiff=function(e){var t=new GeotiffParser;if(t.parseHeader(e),t.consoleTiffProperty(),!t.isGeotiff())throw TypeError("Not a Geotiff data");var a=t.getCRSCode();if(4326!=a&&3857!=a&&102113!=a)throw TypeError("This reference system is not handled : use proj4js in conjunction to OL3 and GeotiffParser"+a);var r=t.ImageToPCS(0,0),o=t.ImageToPCS(t.imageWidth,0),n=t.ImageToPCS(0,t.imageLength),l=t.ImageToPCS(t.imageWidth,t.imageLength);if(1!=r[0]||1!=o[0]||1!=n[0]||1!=l[0])throw TypeError("BBox error");var s=[];s.push(r.splice(1,2)),s.push(o.splice(1,2)),s.push(l.splice(1,2)),s.push(n.splice(1,2));var f="EPSG:"+a.toString(),u={WKID:f,coord:s};i.addCanvasLayer(t,u)},this.addCanvasLayer=function(t,a){var r=e.getView().getProjection().getCode(),o=function(o,n,l,s,f){var u=document.createElement("canvas"),g=u.getContext("2d"),c=s[0],d=s[1];u.setAttribute("width",c),u.setAttribute("height",d);var m=e.getView().calculateExtent(e.getSize()),p=e.getPixelFromCoordinate([o[0],o[3]]),h=e.getPixelFromCoordinate([m[0],m[3]]),v=[h[0]-p[0],h[1]-p[1]];return i.drawImage(t,r,a,v,g),u},n=new ol.layer.Image({source:new ol.source.ImageCanvas({canvasFunction:o,projection:r})});e.addLayer(n)},this.drawImage=function(t,a,i,r,o){var n=!1,l=document.getElementById("MixMaxCb"),s=[];null!=l&&"undefined"!=l&&1==l.checked&&(n=!0,s[0]=document.getElementById("MinValueOfMinMax").value,s[1]=document.getElementById("MaxValueOfMinMax").value);var f=i.coord;if(i.WKID!=a){for(var u=0;u<f.length;u++)f[u]=ol.proj.transform(i.coord[u],i.WKID,a);i.WKID=a}var g=e.getPixelFromCoordinate(f[0]);g[0]=Math.ceil(g[0]+r[0]),g[1]=Math.ceil(g[1]+r[1]);var c=e.getPixelFromCoordinate(f[2]);c[0]=Math.floor(c[0]+r[0]),c[1]=Math.floor(c[1]+r[1]);var d=t.getCRSCode(),m="EPSG:"+d.toString();o.fillStyle=t.makeRGBAFillValue(255,255,255,0);for(var p=255,h=0,v=0,y=this.options.opacity,x=1,C=g[1];C<c[1];C++)for(var P=C-r[1],S=g[0];S<c[0];S++){var I,M=S-r[0],T=e.getCoordinateFromPixel([M,P]);I=m!=a?ol.proj.transform(T,a,m):T;var G=t.PCSToImage(I[0],I[1]);if(1==G[0]){var w=t.getPixelValueOnDemand(G[1],G[2]);null!=w?(1==n?pixrgba=t.getMinMaxPixelValue(w,s[0],s[1]):pixrgba=t.getRGBAPixelValue(w),o.fillStyle=t.makeRGBAFillValue(pixrgba[0],pixrgba[1],pixrgba[2],y)):o.fillStyle=t.makeRGBAFillValue(p,h,v,x)}else o.fillStyle=t.makeRGBAFillValue(p,h,v,x);o.fillRect(S,C,1,1)}}}